@model ProductDisplayModel
@{
}

<!-- Add these to your _Layout.cshtml head section -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" />
<style>
    .toast-top-right {
        top: 70px;
        right: 12px;
    }

    .toast-success {
        background-color: #28a745 !important;
    }

    .product-details-img {
        max-height: 300px;
        width: auto;
        display: block;
        margin: 0 auto;
    }
</style>

<div class="my-2">
    <form asp-action="Index" class="row row-cols-lg-auto g-3 align-items-center">
        <div class="col-12">
            <label class="visually-hidden" for="categoryId">Categories</label>
            <select class="form-select" id="categoryId" name="categoryId">
                <option selected>Category</option>
                @foreach (var category in Model.Categorys)
                {
                    <option selected="@(category.Id == Model.CategoryId)" value="@category.Id">@category.CategoryName</option>
                }
            </select>
        </div>

        <div class="col-12">
            <label class="visually-hidden" for="sterm">Search by title</label>
            <div class="input-group">
                <div class="input-group-text"></div>
                <input type="text" class="form-control" value="@Model.STerm" id="sterm" name="sterm" placeholder="Search by title">
            </div>
        </div>

        <div class="col-12">
            <button type="submit" class="btn btn-primary">Search</button>
            <a href="/Home/Index" class="btn btn-dark">Reset</a>
        </div>
    </form>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailsModalLabel">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="productDetailsContent">
                <!-- Content will be loaded here dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="modalAddToCartBtn" class="btn btn-primary">Add to Cart</button>
            </div>
        </div>
    </div>
</div>

<div class="w-100 mt-4 d-flex flex-wrap">
    @foreach (var product in Model.Products)
    {
        <div class="card mx-3 mb-4" style="width: 11rem;">
            @if (string.IsNullOrEmpty(product.Image))
            {
                <img style="width:100%;height:180px; object-fit: contain" src="/images/NoImage.png" class="card-img-top" alt="@product.ProductName">
            }
            else
            {
                <img style="width:100%;height:180px; object-fit: contain" src="/images/@product.Image" class="card-img-top" alt="@product.ProductName">
            }
            <div class="card-body d-flex flex-column" style="height: 200px;">
                <div>
                    <h5 class="card-title" style="font-size: 1rem; height: 2.5rem; overflow: hidden; text-overflow: ellipsis; cursor: pointer;"
                        onclick="showProductDetails(@product.Id)">
                        @product.ProductName
                    </h5>
                    <p class="card-text mb-2">
                        <small><b>Category: </b>@product.CategoryName</small><br />
                        <small><b>Price: </b>@product.Price$</small><br />
                        <small><b>Quantity: </b>@product.Quantity</small>
                    </p>
                </div>
                <div class="mt-auto">
                    @if (product.Quantity > 0)
                    {
                        <button type="button" onclick="add(@product.Id)"
                                data-product-id="@product.Id"
                                class="btn btn-primary w-100">
                            Add to cart
                        </button>
                    }
                    else
                    {
                        <span style="border: 1px solid;padding: 5px 8px;color: red;border-radius: 5px; display: block; text-align: center;">Out of stock</span>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <!-- Add these scripts before your custom scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

    <script>
        // Configure Toastr
        toastr.options = {
            positionClass: "toast-top-right",
            preventDuplicates: true,
            progressBar: true,
            timeOut: 2000,
            closeButton: true
        };

        // Your existing add to cart function with Toastr
        async function add(productId) {
            var usernameEl = document.getElementById("username");
            if(usernameEl == null) {
                window.location.href = "/Identity/Account/Login";
                return;
            }

            try {
                var response = await fetch(`/Cart/AddItem?productId=${productId}`);
                if (response.status == 200) {
                    var result = await response.json();
                    var cartCountEl = document.getElementById("cartCount");
                    cartCountEl.innerHTML = result;

                    toastr.success('Product added to cart successfully!');
                    window.location.href = "#cartCount";
                } else {
                    toastr.error('Failed to add product to cart');
                }
            }
            catch (err) {
                console.log(err);
                toastr.error('An error occurred while adding to cart');
            }
        }

        // Product details modal function
        function showProductDetails(productId) {
            // Find the product card
            const productCard = document.querySelector(`[data-product-id="${productId}"]`).closest('.card');

            // Extract product details
            const productName = productCard.querySelector('.card-title').textContent.trim();
            const imageSrc = productCard.querySelector('.card-img-top').src;
            const category = productCard.querySelector('p.card-text small:nth-of-type(1)').textContent.replace('Category: ', '').trim();
            const price = productCard.querySelector('p.card-text small:nth-of-type(2)').textContent.replace('Price: ', '').trim();
            const quantity = productCard.querySelector('p.card-text small:nth-of-type(3)').textContent.replace('Quantity: ', '').trim();

            // Generate product description (lorem ipsum)
            const description = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.";

            // Build modal content
            const modalContent = `
                <div class="row">
                    <div class="col-md-6">
                        <img src="${imageSrc}" class="product-details-img img-fluid" alt="${productName}">
                    </div>
                    <div class="col-md-6">
                        <h4>${productName}</h4>
                        <p><strong>Category:</strong> ${category}</p>
                        <p><strong>Price:</strong> ${price}</p>
                        <p><strong>Availability:</strong> ${quantity > 0 ? 'In Stock' : 'Out of Stock'}</p>
                        <hr>
                        <h5>Product Description</h5>
                        <p>${description}</p>
                        <h5 class="mt-3">Features</h5>
                        <ul>
                            <li>High-quality materials</li>
                            <li>Manufacturer warranty</li>
                            <li>Easy to use</li>
                            <li>Energy efficient</li>
                        </ul>
                    </div>
                </div>
            `;

            // Set modal content
            document.getElementById('productDetailsContent').innerHTML = modalContent;

            // Set up Add to Cart button in modal
            const addToCartBtn = document.getElementById('modalAddToCartBtn');
            if (parseInt(quantity) > 0) {
                addToCartBtn.style.display = 'block';
                addToCartBtn.onclick = function() {
                    add(productId);
                    bootstrap.Modal.getInstance(document.getElementById('productDetailsModal')).hide();
                };
            } else {
                addToCartBtn.style.display = 'none';
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
            modal.show();
        }
    </script>
}